volumes:
  ckan_storage:
  solr_data:
  pip_cache:
  site_packages:

services:

  ckan:
    build:
      context: .
      dockerfile: Dockerfile.custom
      args:
        - TZ=${TZ}
    networks:
      - s4idtcities        # ✅ use your existing network
    # Port removed - CKAN accessed via nginx on port 8443
    env_file:
      - .env
    environment:
      # ✅ Point CKAN to existing Postgres and Redis within s4idtcities network
      - CKAN_SQLALCHEMY_URL=postgresql://ckan-user:ckan-pass@keycloak_postgres:5432/ckandb
      - CKAN_DATASTORE_WRITE_URL=postgresql://ckan-user:ckan-pass@keycloak_postgres:5432/datastore
      - CKAN_DATASTORE_READ_URL=postgresql://readonlyuser:readonlypass@keycloak_postgres:5432/datastore
      - CKAN_REDIS_URL=redis://redis:6379/0

      # ✅ Plugins and configuration
      - CKAN__PLUGINS=image_view text_view datatables_view pdf_view geo_view geojson_view shp_view wmts_view video_view audio_view webpage_view resource_proxy datastore xloader envvars custom_theme saml2auth
      - CKANEXT__XLOADER__JOBS__DB_URI=postgresql://ckan-user:ckan-pass@keycloak_postgres:5432/ckandb
      - CKAN__VIEWS__DEFAULT_VIEWS=image_view text_view datatables_view pdf_view geo_view geojson_view
      - CKAN__RESOURCE_PROXY__MAX_FILE_SIZE=50000000

      # ✅ CKAN Site Configuration
      - CKAN__SITE__URL=https://datagate.idtcities.com
      - CKAN__SITE__ID=default
      
      # ✅ File Upload Configuration
      - CKAN__UPLOADS__ENABLED=true
      - CKAN__STORAGE__PATH=/var/lib/ckan/default
      
      # ✅ SAML2 settings with correct domain
      - CKANEXT__SAML2AUTH__IDP_METADATA__LOCATION=remote
      - CKANEXT__SAML2AUTH__IDP_METADATA__REMOTE_URL=https://auth.idtcities.com/realms/IdtCities/protocol/saml/descriptor
      - CKANEXT__SAML2AUTH__USER_FIRSTNAME=urn:oid:2.5.4.42
      - CKANEXT__SAML2AUTH__USER_LASTNAME=urn:oid:2.5.4.4
      - CKANEXT__SAML2AUTH__USER_FULLNAME=name
      - CKANEXT__SAML2AUTH__USER_EMAIL=urn:oid:1.2.840.113549.1.9.1
      - CKANEXT__SAML2AUTH__ENTITY_ID=https://datagate.idtcities.com/saml2/metadata
      - CKANEXT__SAML2AUTH__ACS_ENDPOINT=/saml2/acs
      - CKANEXT__SAML2AUTH__ENABLE_CKAN_INTERNAL_LOGIN=false
      - CKANEXT__SAML2AUTH__WANT_RESPONSE_SIGNED=false
      - CKANEXT__SAML2AUTH__WANT_ASSERTIONS_SIGNED=false
      - CKANEXT__SAML2AUTH__ASSERTION_CONSUMER_SERVICE_BINDING=urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST
      - CKANEXT__SAML2AUTH__SP__NAME_ID_FORMAT=urn:oasis:names:tc:SAML:2.0:nameid-format:persistent

    depends_on:
      solr:
        condition: service_healthy

    volumes:
      - ckan_storage:/var/lib/ckan
      - pip_cache:/root/.cache/pip
      - site_packages:/usr/lib/python3.10/site-packages

    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO", "/dev/null", "http://localhost:5000/api/action/status_show"]
      interval: 60s
      timeout: 10s
      retries: 3

  datapusher:
    build:
      context: datapusher/
    networks:
      - s4idtcities
    environment:
      - DATAPUSHER_SSL_VERIFY=0
      - DATAPUSHER_REWRITE_URL=True
      - DATAPUSHER_LOG_LEVEL=DEBUG
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO", "/dev/null", "http://localhost:8800"]
      interval: 60s
      timeout: 10s
      retries: 3

  solr:
    image: ckan/ckan-solr:${SOLR_IMAGE_VERSION}
    networks:
      - s4idtcities
    volumes:
      - solr_data:/var/solr
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO", "/dev/null", "http://localhost:8983/solr/"]

  nginx:
    build:
      context: nginx/
    networks:
      - s4idtcities
    ports:
      - "8443:443"
    depends_on:
      - ckan
    restart: unless-stopped

networks:
  s4idtcities:
    external: true    # ✅ this tells Docker not to create it, just use existing one
